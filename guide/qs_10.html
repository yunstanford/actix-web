<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Middlewares - Actix web</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Actix web framework guide">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <base href="">

        <link rel="stylesheet" href="book.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <link rel="shortcut icon" href="favicon.png">

        <!-- Font Awesome -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme -->
        

        

        <!-- Fetch Clipboard.js from CDN but have a local fallback -->
        <script src="https://cdn.jsdelivr.net/clipboard.js/1.6.1/clipboard.min.js"></script>
        <script>
            if (typeof Clipboard == 'undefined') {
                document.write(unescape("%3Cscript src='clipboard.min.js'%3E%3C/script%3E"));
            }
        </script>

    </head>
    <body class="light">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { } 
            if (theme === null || theme === undefined) { theme = 'light'; }
            document.body.className = theme;
            document.querySelector('html').className = theme;
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            document.querySelector('html').classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <ol class="chapter"><li class="affix"><a href="qs_1.html">Quickstart</a></li><li><a href="qs_2.html"><strong aria-hidden="true">1.</strong> Getting Started</a></li><li><a href="qs_3.html"><strong aria-hidden="true">2.</strong> Application</a></li><li><a href="qs_3_5.html"><strong aria-hidden="true">3.</strong> Server</a></li><li><a href="qs_4.html"><strong aria-hidden="true">4.</strong> Handler</a></li><li><a href="qs_4_5.html"><strong aria-hidden="true">5.</strong> Errors</a></li><li><a href="qs_5.html"><strong aria-hidden="true">6.</strong> URL Dispatch</a></li><li><a href="qs_7.html"><strong aria-hidden="true">7.</strong> Request &amp; Response</a></li><li><a href="qs_8.html"><strong aria-hidden="true">8.</strong> Testing</a></li><li><a href="qs_10.html" class="active"><strong aria-hidden="true">9.</strong> Middlewares</a></li><li><a href="qs_12.html"><strong aria-hidden="true">10.</strong> Static file handling</a></li><li><a href="qs_9.html"><strong aria-hidden="true">11.</strong> WebSockets</a></li><li><a href="qs_13.html"><strong aria-hidden="true">12.</strong> HTTP/2</a></li><li><a href="qs_14.html"><strong aria-hidden="true">13.</strong> Database integration</a></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light <span class="default">(default)</span></button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                        </div>

                        <h1 class="menu-title">Actix web</h1>

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <a class="header" href="qs_10.html#middlewares" id="middlewares"><h1>Middlewares</h1></a>
<p>Actix middlewares system allows to add additional behavior to request/response processing.
Middleware can hook into incoming request process and modify request or halt request
processing and return response early. Also it can hook into response processing.</p>
<p>Typically middlewares involves in following actions:</p>
<ul>
<li>Pre-process the Request</li>
<li>Post-process a Response</li>
<li>Modify application state</li>
<li>Access external services (redis, logging, sessions)</li>
</ul>
<p>Middlewares are registered for each application and get executed in same order as
registration order. In general, <em>middleware</em> is a type that implements
<a href="../actix_web/middlewares/trait.Middleware.html"><em>Middleware trait</em></a>. Each method
in this trait has default implementation. Each method can return result immediately
or <em>future</em> object.</p>
<p>Here is example of simple middleware that adds request and response headers:</p>
<pre><pre class="playpen"><code class="language-rust"># extern crate http;
# extern crate actix_web;
use http::{header, HttpTryFrom};
use actix_web::*;
use actix_web::middleware::{Middleware, Started, Response};

struct Headers;  // &lt;- Our middleware

/// Middleware implementation, middlewares are generic over application state,
/// so you can access state with `HttpRequest::state()` method.
impl&lt;S&gt; Middleware&lt;S&gt; for Headers {

    /// Method is called when request is ready. It may return
    /// future, which should resolve before next middleware get called.
    fn start(&amp;self, req: &amp;mut HttpRequest&lt;S&gt;) -&gt; Result&lt;Started&gt; {
        req.headers_mut().insert(
            header::CONTENT_TYPE, header::HeaderValue::from_static(&quot;text/plain&quot;));
        Ok(Started::Done)
    }

    /// Method is called when handler returns response,
    /// but before sending http message to peer.
    fn response(&amp;self, req: &amp;mut HttpRequest&lt;S&gt;, mut resp: HttpResponse) -&gt; Result&lt;Response&gt; {
        resp.headers_mut().insert(
            header::HeaderName::try_from(&quot;X-VERSION&quot;).unwrap(),
            header::HeaderValue::from_static(&quot;0.2&quot;));
        Ok(Response::Done(resp))
    }
}

fn main() {
    Application::new()
       .middleware(Headers)  // &lt;- Register middleware, this method could be called multiple times
       .resource(&quot;/&quot;, |r| r.h(httpcodes::HttpOk));
}
</code></pre></pre>
<p>Active provides several useful middlewares, like <em>logging</em>, <em>user sessions</em>, etc.</p>
<a class="header" href="qs_10.html#logging" id="logging"><h2>Logging</h2></a>
<p>Logging is implemented as middleware.
It is common to register logging middleware as first middleware for application.
Logging middleware has to be registered for each application. <em>Logger</em> middleware
uses standard log crate to log information. You should enable logger for <em>actix_web</em>
package to see access log. (<a href="https://docs.rs/env_logger/*/env_logger/">env_logger</a> or similar)</p>
<a class="header" href="qs_10.html#usage" id="usage"><h3>Usage</h3></a>
<p>Create <code>Logger</code> middleware with the specified <code>format</code>.
Default <code>Logger</code> could be created with <code>default</code> method, it uses the default format:</p>
<pre><code class="language-ignore">  %a %t &quot;%r&quot; %s %b &quot;%{Referer}i&quot; &quot;%{User-Agent}i&quot; %T
</code></pre>
<pre><pre class="playpen"><code class="language-rust"># extern crate actix_web;
extern crate env_logger;
use actix_web::Application;
use actix_web::middleware::Logger;

fn main() {
    std::env::set_var(&quot;RUST_LOG&quot;, &quot;actix_web=info&quot;);
    env_logger::init();

    Application::new()
       .middleware(Logger::default())
       .middleware(Logger::new(&quot;%a %{User-Agent}i&quot;))
       .finish();
}
</code></pre></pre>
<p>Here is example of default logging format:</p>
<pre><code>INFO:actix_web::middleware::logger: 127.0.0.1:59934 [02/Dec/2017:00:21:43 -0800] &quot;GET / HTTP/1.1&quot; 302 0 &quot;-&quot; &quot;curl/7.54.0&quot; 0.000397
INFO:actix_web::middleware::logger: 127.0.0.1:59947 [02/Dec/2017:00:22:40 -0800] &quot;GET /index.html HTTP/1.1&quot; 200 0 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:57.0) Gecko/20100101 Firefox/57.0&quot; 0.000646
</code></pre>
<a class="header" href="qs_10.html#format" id="format"><h3>Format</h3></a>
<p><code>%%</code>  The percent sign</p>
<p><code>%a</code>  Remote IP-address (IP-address of proxy if using reverse proxy)</p>
<p><code>%t</code>  Time when the request was started to process</p>
<p><code>%P</code>  The process ID of the child that serviced the request</p>
<p><code>%r</code>  First line of request</p>
<p><code>%s</code>  Response status code</p>
<p><code>%b</code>  Size of response in bytes, including HTTP headers</p>
<p><code>%T</code>  Time taken to serve the request, in seconds with floating fraction in .06f format</p>
<p><code>%D</code>  Time taken to serve the request, in milliseconds</p>
<p><code>%{FOO}i</code>  request.headers['FOO']</p>
<p><code>%{FOO}o</code>  response.headers['FOO']</p>
<p><code>%{FOO}e</code>  os.environ['FOO']</p>
<a class="header" href="qs_10.html#default-headers" id="default-headers"><h2>Default headers</h2></a>
<p>To set default response headers <code>DefaultHeaders</code> middleware could be used.
<em>DefaultHeaders</em> middleware does not set header if response headers already contains
specified header.</p>
<pre><pre class="playpen"><code class="language-rust"># extern crate actix_web;
use actix_web::*;

fn main() {
    let app = Application::new()
        .middleware(
            middleware::DefaultHeaders::build()
                .header(&quot;X-Version&quot;, &quot;0.2&quot;)
                .finish())
        .resource(&quot;/test&quot;, |r| {
             r.method(Method::GET).f(|req| httpcodes::HttpOk);
             r.method(Method::HEAD).f(|req| httpcodes::HttpMethodNotAllowed);
        })
       .finish();
}
</code></pre></pre>
<a class="header" href="qs_10.html#user-sessions" id="user-sessions"><h2>User sessions</h2></a>
<p>Actix provides general solution for session management.
<a href="../actix_web/middleware/struct.SessionStorage.html"><em>Session storage</em></a> middleware can be
use with different backend types to store session data in different backends.
By default only cookie session backend is implemented. Other backend implementations
could be added later.</p>
<p><a href="../actix_web/middleware/struct.CookieSessionBackend.html"><em>Cookie session backend</em></a>
uses signed cookies as session storage. <em>Cookie session backend</em> creates sessions which
are limited to storing fewer than 4000 bytes of data (as the payload must fit into a
single cookie). Internal server error get generated if session contains more than 4000 bytes.</p>
<p>You need to pass a random value to the constructor of <em>CookieSessionBackend</em>.
This is private key for cookie session. When this value is changed, all session data is lost.
Note that whatever you write into your session is visible by the user (but not modifiable).</p>
<p>In general case, you create
<a href="../actix_web/middleware/struct.SessionStorage.html"><em>Session storage</em></a> middleware
and initializes it with specific backend implementation, like <em>CookieSessionBackend</em>.
To access session data
<a href="../actix_web/middleware/trait.RequestSession.html#tymethod.session"><em>HttpRequest::session()</em></a>
method has to be used. This method returns
<a href="../actix_web/middleware/struct.Session.html"><em>Session</em></a> object, which allows to get or set
session data.</p>
<pre><pre class="playpen"><code class="language-rust"># extern crate actix;
# extern crate actix_web;
use actix_web::*;
use actix_web::middleware::{RequestSession, SessionStorage, CookieSessionBackend};

fn index(mut req: HttpRequest) -&gt; Result&lt;&amp;'static str&gt; {
    // access session data
    if let Some(count) = req.session().get::&lt;i32&gt;(&quot;counter&quot;)? {
        println!(&quot;SESSION value: {}&quot;, count);
        req.session().set(&quot;counter&quot;, count+1)?;
    } else {
        req.session().set(&quot;counter&quot;, 1)?;
    }

    Ok(&quot;Welcome!&quot;)
}

fn main() {
#   let sys = actix::System::new(&quot;basic-example&quot;);
    HttpServer::new(
        || Application::new()
            .middleware(SessionStorage::new(          // &lt;- create session middleware
                CookieSessionBackend::build(&amp;[0; 32]) // &lt;- create cookie session backend
                    .secure(false)
                    .finish()
            )))
        .bind(&quot;127.0.0.1:59880&quot;).unwrap()
        .start();
#     actix::Arbiter::system().do_send(actix::msgs::SystemExit(0));
#     let _ = sys.run();
}
</code></pre></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="qs_8.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="qs_12.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="qs_8.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="qs_12.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>


        <!-- Local fallback for Font Awesome -->
        <script>
            if (getComputedStyle(document.querySelector(".fa")).fontFamily !== "FontAwesome") {
                var link = document.createElement('link');
                link.rel = 'stylesheet';
                link.type = 'text/css';
                link.href = '_FontAwesome/css/font-awesome.css';
                document.head.insertBefore(link, document.head.firstChild)
            }
        </script>

        

        
        <!-- Google Analytics Tag -->
        <script>
            var localAddrs = ["localhost", "127.0.0.1", ""];

            // make sure we don't activate google analytics if the developer is
            // inspecting the book locally...
            if (localAddrs.indexOf(document.location.hostname) === -1) {
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-110322332-1', 'auto');
                ga('send', 'pageview');
            }
        </script>
        

        

        

        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS script -->
        

    </body>
</html>
